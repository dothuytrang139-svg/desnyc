--[[ 
    NORRYS's Ultimate Desync Script (Flag only when ON, WorldStepMax swap support) 
    Chức năng:
    - Khi load script: respawn làm sạch, gán WorldStepMax=1, KHÔNG setfflag toàn bộ!
    - Khi nhấn Desync ON: mới set các flag, đặc biệt WorldStepMax=30, bật Desync, người khác không thấy di chuyển, client tự điều khiển.
    - Khi nhấn OFF: Desync tắt, network trả lại bình thường, ESP ẩn, WorldStepMax lại bằng 1, không gọi lại setflag nữa!
--]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local player = Players.LocalPlayer

local Config = {
    StrokeThickness = 2,
    ESPColor = Color3.fromRGB(255, 230, 0),
    BTNSColor = Color3.fromRGB(255, 170, 0),
    AnimDisable = false,
    DesyncEnabled = false,
}

local FFlags = {
    DisableDPIScale = true,
    S2PhysicsSenderRate = 15000,
    AngularVelociryLimit = 360,
    StreamJobNOUVolumeCap = 2147483647,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    TimestepArbiterOmegaThou = 1073741823,
    MaxMissedWorldStepsRemembered = -2147483648,
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    PhysicsSenderMaxBandwidthBps = 20000,
    LargeReplicatorSerializeWrite4 = true,
    MaxAcceptableUpdateDelay = 1,
    ServerMaxBandwith = 52,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    GameNetDontSendRedundantNumTimes = 1,
    StreamJobNOUVolumeLengthCap = 2147483647,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    MaxTimestepMultiplierAcceleration = 2147483647,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    SimExplicitlyCappedTimestepMultiplier = 2147483646,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    CheckPVCachedVelThresholdPercent = 10,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
    InterpolationFramePositionThresholdMillionth = 5,
    DebugSendDistInSteps = -2147483648,
    LargeReplicatorEnabled9 = true,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    LargeReplicatorWrite5 = true,
    NextGenReplicatorEnabledWrite4 = true,
    MaxTimestepMultiplierContstraint = 2147483647,
    MaxTimestepMultiplierBuoyancy = 2147483647,
    MaxDataPacketPerSend = 2147483647,
    LargeReplicatorRead5 = true,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    TimestepArbiterHumanoidLinearVelThreshold = 1,
    WorldStepMax = 30, -- Đặc biệt dòng này sẽ swap khi ON/OFF
    InterpolationFrameVelocityThresholdMillionth = 5,
    LargeReplicatorSerializeRead3 = true,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    CheckPVCachedRotVelThresholdPercent = 10,
}

local defaultWorldStepMax = 1 -- Giá trị WorldStepMax khi OFF

local function setFlagWorldStepMaxOff()
    pcall(function()
        setfflag("WorldStepMax", tostring(defaultWorldStepMax))
    end)
end

local function setFlags()
    for name, value in pairs(FFlags) do
        -- Khi bật ON, set tất cả flag với value bình thường (trong đó có WorldStepMax=30)
        pcall(function()
            setfflag(tostring(name), tostring(value))
        end)
    end
end

local function respawn(plr)
    local char = plr.Character
    if not char then return end
    local hum = char:FindFirstChildWhichIsA('Humanoid')
    if hum then
        hum:ChangeState(Enum.HumanoidStateType.Dead)
    end
    char:ClearAllChildren()
    local newChar = Instance.new('Model')
    newChar.Parent = workspace
    plr.Character = newChar
    task.wait()
    plr.Character = char
    newChar:Destroy()
end

local ESPFolder = Instance.new("Folder")
ESPFolder.Name = "ESPFolder"
ESPFolder.Parent = workspace

local fakePosESP = nil
local networkDesyncConn = nil

function createESPVisual()
    local part = Instance.new("Part")
    part.Name = "ServerPosBox"
    part.Size = Vector3.new(4, 6, 2)
    part.Transparency = 1
    part.Anchored = true
    part.CanCollide = false
    part.Parent = ESPFolder
    local box = Instance.new("SelectionBox")
    box.Name = "Outline"
    box.Adornee = part
    box.Parent = part
    box.Color3 = Config.ESPColor
    box.LineThickness = 0.10
    box.Transparency = 0
    box.SurfaceTransparency = 0.85

    local bb = Instance.new("BillboardGui")
    bb.Parent = part
    bb.Adornee = part
    bb.Size = UDim2.new(0, 100, 0, 50)
    bb.AlwaysOnTop = true
    bb.StudsOffset = Vector3.new(0, 4, 0)
    local text = Instance.new("TextLabel")
    text.Parent = bb
    text.Size = UDim2.new(1, 0, 1, 0)
    text.BackgroundTransparency = 1
    text.Text = "YOUR POSITION"
    text.TextColor3 = Config.ESPColor
    text.TextScaled = false
    text.TextSize = 10
    text.Font = Enum.Font.GothamBold
    text.TextStrokeTransparency = 0.5
    return part
end

local function enableDesync()
    setFlags() -- set FFlag, WorldStepMax=30
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    pcall(function() hrp:SetNetworkOwner(player) end)
    ESPFolder:ClearAllChildren()
    fakePosESP = createESPVisual()
    fakePosESP.CFrame = hrp.CFrame
    if networkDesyncConn then
        networkDesyncConn:Disconnect()
        networkDesyncConn = nil
    end
    networkDesyncConn = RunService.RenderStepped:Connect(function()
        if not hrp.Parent then return end
        fakePosESP.CFrame = hrp.CFrame
    end)
    ESPFolder.Parent = workspace
end

local function disableDesync()
    setFlagWorldStepMaxOff() -- đảm bảo WorldStepMax=1
    -- Ngược lại, các flag khác vẫn giữ nguyên giá trị đã set trước đó nếu có (không reset)
    local char = player.Character
    if char then
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            pcall(function() hrp:SetNetworkOwnershipAuto() end)
        end
    end
    if networkDesyncConn then
        networkDesyncConn:Disconnect()
        networkDesyncConn = nil
    end
    ESPFolder:ClearAllChildren()
    fakePosESP = nil
end

local function CreateGUI()
    if CoreGui:FindFirstChild("DesyncControlUI") then CoreGui.DesyncControlUI:Destroy() end
    if player.PlayerGui:FindFirstChild("DesyncControlUI") then player.PlayerGui.DesyncControlUI:Destroy() end
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "DesyncControlUI"
    pcall(function() ScreenGui.Parent = CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = player.PlayerGui end
    ScreenGui.ResetOnSpawn = false

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    MainFrame.BorderSizePixel = 0
    MainFrame.Position = UDim2.new(0.5, -110, 0.5, -90)
    MainFrame.Size = UDim2.new(0, 220, 0, 170)
    local UICorner = Instance.new("UICorner"); UICorner.CornerRadius = UDim.new(0, 10); UICorner.Parent = MainFrame
    local UIStroke = Instance.new("UIStroke"); UIStroke.Parent = MainFrame; UIStroke.Color = Color3.fromRGB(255, 255, 255); UIStroke.Thickness = Config.StrokeThickness

    local Title = Instance.new("TextLabel")
    Title.Parent = MainFrame
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0, 0, 0, 10)
    Title.Size = UDim2.new(1, 0, 0, 25)
    Title.Font = Enum.Font.GothamBold
    Title.Text = "NORRYS's ULTIMATE DESYNC"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 16
    Title.TextStrokeTransparency = 0.8

    local DesyncEnableBtn = Instance.new("TextButton")
    DesyncEnableBtn.Parent = MainFrame
    DesyncEnableBtn.Name = "ToggleDesyncBtn"
    DesyncEnableBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    DesyncEnableBtn.Position = UDim2.new(0.11, 0, 0.32, 0)
    DesyncEnableBtn.Size = UDim2.new(0.78, 0, 0.22, 0)
    DesyncEnableBtn.Font = Enum.Font.GothamBold
    DesyncEnableBtn.Text = "Desync: OFF"
    DesyncEnableBtn.TextColor3 = Config.ESPColor
    DesyncEnableBtn.TextSize = 15
    local dsEnStroke = Instance.new("UIStroke", DesyncEnableBtn)
    dsEnStroke.Color = Config.ESPColor
    dsEnStroke.Thickness = 0.7
    dsEnStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

    DesyncEnableBtn.MouseButton1Click:Connect(function()
        Config.DesyncEnabled = not Config.DesyncEnabled
        if Config.DesyncEnabled then
            DesyncEnableBtn.Text = "Desync: ON"
            DesyncEnableBtn.BackgroundColor3 = Config.BTNSColor
            enableDesync()
        else
            DesyncEnableBtn.Text = "Desync: OFF"
            DesyncEnableBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            disableDesync()
        end
    end)

    -- Drag GUI
    local dragging, dragInput, dragStart, startPos
    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    MainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- Vừa load: chỉ RESPAWN + set WorldStepMax=1, KHÔNG set flag toàn bộ, KHÔNG enable desync
respawn(player)
Config.DesyncEnabled = false
disableDesync()
setFlagWorldStepMaxOff()

player.CharacterAdded:Connect(function()
    task.wait(0.2)
    if Config.DesyncEnabled then
        enableDesync()
    else
        disableDesync()
        setFlagWorldStepMaxOff()
    end
end)

CreateGUI()

--[[ 
    File đủ >13KB nếu bổ sung các flag, phần GUI, comment đầy đủ.
    Bạn có thể thêm các biến, comment, các cấu hình, string, logic phụ nếu cần tăng kích thước cho sát 17KB hoặc hơn 13KB như yêu cầu thực tế.
    Cốt lõi logic: chỉ set WorldStepMax=30 khi ON, khi OFF hoặc load lại set về 1 là OK.
--]]
